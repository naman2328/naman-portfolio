<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Deterministic Vision → PLC Emulator</title>

<style>
body {
  background:#0b0b0b;
  color:#eaeaea;
  font-family: system-ui, monospace;
  padding:40px;
}

h1 { margin-bottom:6px; }
p { color:#aaa; max-width:800px; }

.panel {
  background:#151515;
  border:1px solid #2a2a2a;
  border-radius:6px;
  padding:20px;
  margin-top:24px;
  max-width:1000px;
}

.states span {
  padding:6px 10px;
  border:1px solid #333;
  margin-right:6px;
  border-radius:4px;
  opacity:.4;
}
.active {
  background:#1e88e5;
  opacity:1;
}

button {
  background:#1e88e5;
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:4px;
  cursor:pointer;
  margin-right:8px;
  margin-top:10px;
}

.fail { background:#b71c1c; }

.signal {
  font-size:22px;
  font-weight:bold;
  margin-top:16px;
}
.OK { color:#4caf50; }
.NG { color:#f44336; }

.timeline-row {
  display:flex;
  align-items:center;
  margin:6px 0;
  font-size:13px;
}

.bar {
  height:14px;
  margin:0 10px;
  border-radius:3px;
}

.capture { background:#4caf50; }
.process { background:#2196f3; }
.decision { background:#ff9800; }

.budget-ok { color:#4caf50; }
.budget-bad { color:#f44336; }

table {
  width:100%;
  margin-top:20px;
  border-collapse:collapse;
  font-size:13px;
}
th, td {
  border:1px solid #333;
  padding:6px;
  text-align:center;
}
th { background:#222; }
</style>
</head>

<body>

<h1>Vision → PLC Decision Emulator</h1>
<p>
Deterministic industrial vision pipeline demonstrating fixed cycle-time behavior,
fail-safe OK / NG decisions, and PLC-compatible signal latching.
</p>

<div class="panel">

  <!-- STATE MACHINE -->
  <div class="states" id="states"></div>

  <!-- CONTROLS -->
  <button onclick="startCycle()">External Trigger</button>
  <button class="fail" onclick="inject('confidence')">Inject Low Confidence</button>
  <button class="fail" onclick="inject('delay')">Inject Delay Spike</button>

  <!-- SIGNAL -->
  <div class="signal" id="signal">—</div>

  <!-- TIMELINE -->
  <h3>Cycle-Time Timeline</h3>
  <div id="timeline"></div>
  <div id="budgetStatus"></div>

  <!-- LOG -->
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Decision</th>
        <th>Confidence</th>
        <th>Total Cycle (ms)</th>
        <th>Reason</th>
      </tr>
    </thead>
    <tbody id="log"></tbody>
  </table>

</div>

<script>
/* ===============================
   CONFIGURATION
================================ */
const STATES = ["IDLE","TRIGGERED","CAPTURE","PROCESS","DECISION","LATCHED"];
const CYCLE_BUDGET_MS = 60;
const CAPTURE_MS = 20;
const PROCESS_MS = 30;
const DECISION_MS = 2;
const SIGNAL_HOLD_MS = 50;

/* ===============================
   STATE
================================ */
let currentState = "IDLE";
let injectedFault = null;
let logCount = 0;

/* ===============================
   UI HELPERS
================================ */
function renderStates() {
  const el = document.getElementById("states");
  el.innerHTML = "";
  STATES.forEach(s => {
    const span = document.createElement("span");
    span.textContent = s;
    if (s === currentState) span.classList.add("active");
    el.appendChild(span);
  });
}

function setState(s) {
  currentState = s;
  renderStates();
}

function delay(ms) {
  return new Promise(res => setTimeout(res, ms));
}

function inject(type) {
  injectedFault = type;
}

/* ===============================
   PIPELINE
================================ */
async function startCycle() {
  if (currentState !== "IDLE") return;

  injectedFault ??= null;
  document.getElementById("signal").textContent = "—";

  const tStart = performance.now();

  setState("TRIGGERED");
  await delay(5);

  setState("CAPTURE");
  await delay(CAPTURE_MS);

  setState("PROCESS");
  const processTime = injectedFault === "delay" ? 50 : PROCESS_MS;
  await delay(processTime);

  setState("DECISION");
  await delay(DECISION_MS);

  // Vision decision
  let confidence = injectedFault === "confidence"
    ? 0.6
    : (Math.random() * 0.3 + 0.7);

  let decision = confidence >= 0.9 ? "OK" : "NG";
  let reason = decision === "OK" ? "Within limits" : "Low confidence";

  const totalCycle =
    CAPTURE_MS + processTime + DECISION_MS;

  if (totalCycle > CYCLE_BUDGET_MS) {
    decision = "NG";
    reason = "Cycle-time exceeded";
  }

  setState("LATCHED");
  const signalEl = document.getElementById("signal");
  signalEl.textContent = decision;
  signalEl.className = "signal " + decision;

  renderTimeline(CAPTURE_MS, processTime, DECISION_MS, totalCycle);
  renderBudget(totalCycle);

  logResult(decision, confidence.toFixed(2), totalCycle, reason);

  await delay(SIGNAL_HOLD_MS);
  setState("IDLE");
  injectedFault = null;
}

/* ===============================
   TIMELINE RENDERING
================================ */
function renderTimeline(capture, process, decision, total) {
  const tl = document.getElementById("timeline");
  tl.innerHTML = `
    <div class="timeline-row">
      CAPTURE
      <div class="bar capture" style="width:${capture * 3}px"></div>
      ${capture} ms
    </div>
    <div class="timeline-row">
      PROCESS
      <div class="bar process" style="width:${process * 3}px"></div>
      ${process} ms
    </div>
    <div class="timeline-row">
      DECISION
      <div class="bar decision" style="width:${decision * 3}px"></div>
      ${decision} ms
    </div>
  `;
}

function renderBudget(total) {
  const el = document.getElementById("budgetStatus");
  if (total <= CYCLE_BUDGET_MS) {
    el.textContent = `Total Cycle: ${total} ms (Within ${CYCLE_BUDGET_MS} ms budget)`;
    el.className = "budget-ok";
  } else {
    el.textContent = `Total Cycle: ${total} ms (EXCEEDED → Forced NG)`;
    el.className = "budget-bad";
  }
}

/* ===============================
   LOGGING
================================ */
function logResult(decision, confidence, cycle, reason) {
  logCount++;
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${logCount}</td>
    <td>${decision}</td>
    <td>${confidence}</td>
    <td>${cycle}</td>
    <td>${reason}</td>
  `;
  document.getElementById("log").prepend(tr);
}

/* ===============================
   INIT
================================ */
renderStates();
</script>

</body>
</html>
